# 视频截图功能产品文档

## 功能概述

视频截图功能允许用户在观看视频时快速捕获当前画面，并支持将字幕叠加到截图上。该功能采用「沉浸式体验 + 后处理」的设计理念，确保截图操作不打断用户观看视频的流畅体验。

### 核心特性

- **一键截图**：点击即保存，无需复杂操作
- **字幕叠加**：自动匹配当前时间点的字幕
- **后处理编辑**：事后可选择多条字幕、调整样式
- **字幕共享**：同一视频的所有截图共享最新字幕数据
- **持久化存储**：截图和字幕数据保存到本地数据库

---

## 用户交互流程

### 核心理念

```
📸 截图 → 轻量反馈 → 继续观看 → 事后编辑
```

### 完整流程图

```
┌─────────────────────────────────────────────────────────────────┐
│                         观看视频阶段                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   用户观看视频                                                    │
│        │                                                         │
│        ▼                                                         │
│   ┌─────────────────┐                                           │
│   │ 点击"视频截图"  │ ◄── 左侧面板按钮                           │
│   └────────┬────────┘                                           │
│            │                                                     │
│            ▼                                                     │
│   ┌─────────────────┐     ┌─────────────────┐                   │
│   │  捕获当前帧画面  │────►│ 自动匹配当前字幕 │                   │
│   └────────┬────────┘     └────────┬────────┘                   │
│            │                       │                             │
│            ▼                       ▼                             │
│   ┌──────────────────────────────────┐                          │
│   │        静默保存到数据库           │                          │
│   └────────────────┬─────────────────┘                          │
│                    │                                             │
│                    ▼                                             │
│            ┌──────────────┐                                      │
│            │ Toast: 已保存 │ ◄── 底部轻量提示，2秒消失            │
│            └──────────────┘                                      │
│                    │                                             │
│                    ▼                                             │
│            继续观看视频 ✓                                         │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                         后处理阶段                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   打开右侧面板 → "截图"标签页                                     │
│        │                                                         │
│        ▼                                                         │
│   ┌─────────────────┐                                           │
│   │   截图列表缩略图  │                                           │
│   └────────┬────────┘                                           │
│            │ 点击                                                │
│            ▼                                                     │
│   ┌─────────────────┐                                           │
│   │   截图详情页     │ ◄── 查看大图、信息、已选字幕               │
│   └────────┬────────┘                                           │
│            │ 点击"编辑"                                          │
│            ▼                                                     │
│   ┌─────────────────────────────────────────┐                   │
│   │              截图编辑器                  │                   │
│   │  ┌─────────────┐  ┌─────────────────┐  │                   │
│   │  │  实时预览    │  │   字幕选择      │  │                   │
│   │  │  (Canvas)   │  │   样式设置      │  │                   │
│   │  └─────────────┘  └─────────────────┘  │                   │
│   └────────────────────┬────────────────────┘                   │
│                        │ 保存                                    │
│                        ▼                                         │
│                 更新截图数据 ✓                                    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 界面设计

### 1. 左侧面板 - 截图按钮

```
┌─────────────────────────────┐
│  📸 视频截图                 │
│     捕获当前画面和字幕        │
└─────────────────────────────┘
```

- **位置**：左侧工具栏
- **交互**：单击触发截图
- **前置条件**：视频已加载（无需播放状态）

### 2. Toast 反馈

```
                    ┌──────────────────────────┐
                    │  📷  已保存到截图库       │
                    └──────────────────────────┘
                         ▲ 底部居中，2秒后消失
```

- **样式**：圆角胶囊形状，深色背景
- **动画**：淡入滑出
- **时长**：2秒自动消失

### 3. 截图面板（右侧）

#### 列表视图

```
┌──────────────────────────────────┐
│  截图库                           │
├──────────────────────────────────┤
│  ┌────────────────────────────┐  │
│  │ ┌────────────────────────┐ │  │
│  │ │                        │ │  │
│  │ │      视频缩略图         │ │  │
│  │ │                  02:15 │ │  │
│  │ └────────────────────────┘ │  │
│  │ How to Learn Python        │  │
│  │ 12/23 14:30    [✏️][⬇️][🗑️]│  │
│  └────────────────────────────┘  │
│                                  │
│  ┌────────────────────────────┐  │
│  │        ...更多截图...       │  │
│  └────────────────────────────┘  │
└──────────────────────────────────┘
```

#### 详情视图

```
┌──────────────────────────────────┐
│  ← 返回          [编辑][⬇️][🗑️] │
├──────────────────────────────────┤
│  ┌────────────────────────────┐  │
│  │                            │  │
│  │         截图大图            │  │
│  │                            │  │
│  └────────────────────────────┘  │
│                                  │
│  视频标题                         │
│  How to Learn Python in 2024     │
│                                  │
│  时间点          创建时间         │
│  02:15          12/23 14:30      │
│                                  │
│  字幕                             │
│  ┌────────────────────────────┐  │
│  │ "This is the first step"  │  │
│  └────────────────────────────┘  │
│                                  │
│  视频链接                         │
│  https://youtube.com/watch?v=... │
└──────────────────────────────────┘
```

### 4. 截图编辑器

```
┌────────────────────────────────────────────────────────────┐
│  截图编辑器                                          [×]   │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  ┌────────────────────────┐  ┌──────────────────────────┐ │
│  │                        │  │ 字幕选择                  │ │
│  │                        │  │ ┌────────────────────┐   │ │
│  │      实时预览           │  │ │ 🔍 搜索字幕...      │   │ │
│  │      (Canvas)          │  │ └────────────────────┘   │ │
│  │                        │  │ ⏱️ ──●────────── ±10s   │ │
│  │                        │  │ ☐ 显示全部 (128)        │ │
│  │  ───────────────────   │  │                          │ │
│  │  "Selected subtitle"   │  │ ┌────────────────────┐   │ │
│  │  ───────────────────   │  │ │ ☐ 02:13 上一条...  │   │ │
│  │                        │  │ │ ☑ 02:15 当前字幕 🔵│   │ │
│  │                        │  │ │ ☐ 02:18 下一条...  │   │ │
│  └────────────────────────┘  │ └────────────────────┘   │ │
│                              │                          │ │
│                              │ [全选] [清空]             │ │
│                              ├──────────────────────────┤ │
│                              │ 样式设置                  │ │
│                              │                          │ │
│                              │ Aa 字体大小               │ │
│                              │ ──────●────── 28px       │ │
│                              │                          │ │
│                              │ 位置  [顶部] [底部●]      │ │
│                              │                          │ │
│                              │ 背景  [半透明●][纯黑][无] │ │
│                              └──────────────────────────┘ │
│                                                            │
├────────────────────────────────────────────────────────────┤
│  [取消]                                         [保存]     │
└────────────────────────────────────────────────────────────┘
```

---

## 字幕管理机制

### 字幕共享设计

采用「视频URL」作为字幕的唯一标识，实现截图和字幕的解耦：

```
┌─────────────┐          ┌─────────────┐
│ Screenshot  │          │  Subtitles  │
│─────────────│          │─────────────│
│ id          │          │ id          │
│ video_url ──┼──────────┼─ video_url  │ (唯一)
│ timestamp   │          │ subtitle_data│
│ image_data  │          │ platform    │
│ ...         │          │ ...         │
└─────────────┘          └─────────────┘
        │                       │
        └───────────┬───────────┘
                    │
            通过 video_url 动态关联
```

### 字幕生命周期

```
┌────────────────────────────────────────────────────────────────┐
│                        字幕数据流                               │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐      │
│  │  获取字幕    │────►│  内存缓存    │────►│  数据库存储  │      │
│  │  (YouTube)  │     │  (tabData)  │     │  (SQLite)   │      │
│  └─────────────┘     └─────────────┘     └─────────────┘      │
│         │                   │                   │               │
│         │                   │                   │               │
│  ┌─────────────┐            │                   │               │
│  │  导入字幕    │────────────┘                   │               │
│  │  (SRT/VTT)  │                                │               │
│  └─────────────┘                                │               │
│                                                 │               │
│  ┌─────────────────────────────────────────────┘               │
│  │                                                              │
│  ▼                                                              │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    自动加载触发                          │   │
│  │  • 打开视频页面时 → 检查数据库 → 有则加载到内存           │   │
│  │  • 编辑截图时 → 通过 videoUrl 获取最新字幕               │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└────────────────────────────────────────────────────────────────┘
```

### 字幕更新策略

| 操作 | 行为 |
|------|------|
| 首次获取字幕 | 保存到数据库 |
| 再次获取字幕 | 更新数据库中的记录（Upsert） |
| 导入字幕文件 | 同上，覆盖已有数据 |
| 编辑截图 | 始终获取最新字幕 |

---

## 用户场景

### 场景 1：基础截图

**用户故事**：作为用户，我想在看到精彩画面时快速截图保存。

**操作流程**：
1. 观看视频，看到想保存的画面
2. 点击「视频截图」按钮
3. 看到 Toast 提示「已保存到截图库」
4. 继续观看视频

**结果**：截图保存成功，不打断观看体验。

---

### 场景 2：带字幕截图

**用户故事**：作为用户，我想截图时自动带上当前的字幕。

**前置条件**：已获取/导入字幕

**操作流程**：
1. 获取字幕（点击「获取字幕」或导入 SRT 文件）
2. 播放视频到想要的位置
3. 点击「视频截图」
4. 截图自动包含当前时间点的字幕

**结果**：截图保存时自动匹配并记录当前字幕。

---

### 场景 3：后处理编辑

**用户故事**：作为用户，我想在看完视频后回顾截图，添加或修改字幕。

**操作流程**：
1. 打开右侧面板 →「截图」标签页
2. 点击想要编辑的截图
3. 在详情页点击「编辑」按钮
4. 在编辑器中：
   - 选择要显示的字幕（可多选）
   - 调整字体大小（滑块 16-48px）
   - 选择位置（顶部/底部）
   - 选择背景样式（半透明/纯黑/无）
5. 实时预览效果
6. 点击「保存」

**结果**：截图更新为带字幕的最终版本。

---

### 场景 4：先截图后添加字幕

**用户故事**：作为用户，我在没有字幕时截了图，之后添加了字幕，想给之前的截图加上字幕。

**操作流程**：
1. （之前）观看视频时截图（无字幕）
2. （之后）获取/导入字幕
3. 打开截图面板，找到之前的截图
4. 点击「编辑」
5. 系统自动加载最新的字幕数据
6. 选择字幕并保存

**结果**：旧截图可以使用新添加的字幕。

---

### 场景 5：字幕更新后编辑

**用户故事**：作为用户，我更新了字幕文件，想让之前的截图使用新字幕。

**操作流程**：
1. 导入新的字幕文件（覆盖旧版本）
2. 打开截图面板，编辑任意截图
3. 系统自动使用最新的字幕

**结果**：编辑器始终显示最新版本的字幕。

---

### 场景 6：重启应用后继续使用

**用户故事**：作为用户，我关闭应用后重新打开，想继续使用之前的字幕。

**操作流程**：
1. 重新打开应用
2. 访问之前看过的视频页面
3. 系统自动加载已保存的字幕到右侧面板

**结果**：无需重新获取字幕，自动恢复。

---

## 技术实现

### 数据模型

#### 截图表 (screenshots)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键 |
| video_url | TEXT | 视频URL（用于关联字幕） |
| video_title | TEXT | 视频标题 |
| timestamp | REAL | 截图时间点（秒） |
| image_data | TEXT | Base64 原始截图 |
| subtitles | TEXT | JSON: 截图时选中的字幕 |
| subtitle_style | TEXT | JSON: 字幕样式配置 |
| final_image_data | TEXT | Base64 合成后的图片 |
| created_at | TEXT | 创建时间 |

#### 字幕表 (subtitles)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键 |
| video_url | TEXT | 视频URL（唯一键） |
| video_title | TEXT | 视频标题 |
| platform | TEXT | 平台（youtube/bilibili/import） |
| subtitle_data | TEXT | JSON: 完整字幕数组 |
| created_at | TEXT | 创建时间 |
| updated_at | TEXT | 更新时间 |

### 组件架构

```
App.tsx
├── Sidebar.tsx ─────────────────► 「视频截图」按钮
├── BrowserView.tsx ─────────────► 视频帧捕获 + URL 变化监听
├── InfoPanel.tsx
│   └── ScreenshotPanel.tsx ─────► 截图列表 + 详情
├── ScreenshotDialog.tsx ────────► 截图编辑器
└── Toast.tsx ───────────────────► 轻量反馈
```

### IPC 通信

| Handler | 功能 |
|---------|------|
| `save-screenshot` | 保存截图 |
| `get-screenshots` | 获取截图列表 |
| `update-screenshot` | 更新截图 |
| `delete-screenshot` | 删除截图 |
| `save-subtitles` | 保存/更新字幕 |
| `get-subtitles-by-url` | 根据URL获取字幕 |

---

## 设计规范

### 视觉风格

采用 Linear 设计语言：

- **色彩**：灰色色阶 (#18181b, #3f3f46, #71717a, #a1a1aa)
- **圆角**：lg (8px) 到 xl (12px)
- **过渡**：150ms ease-out
- **字体**：系统字体栈，等宽数字

### 交互原则

1. **轻量优先**：截图操作不打断主流程
2. **渐进增强**：简单场景一键完成，复杂场景提供编辑器
3. **即时反馈**：所有操作都有视觉反馈
4. **数据安全**：本地存储，持久化

---

## 限制与说明

1. **视频源要求**：视频元素需可被 Canvas 捕获（部分加密内容可能受限）
2. **截图格式**：PNG 格式，无损保存
3. **字幕匹配**：基于时间戳精确匹配，支持 ±N 秒范围选择
4. **存储位置**：用户数据目录下的 SQLite 数据库

---

## 版本历史

| 版本 | 日期 | 更新内容 |
|------|------|---------|
| 1.0 | - | 基础截图功能 |
| 1.1 | - | 添加字幕叠加 |
| 2.0 | 2024-12 | 沉浸式体验重构：静默截图 + Toast 反馈 |
| 2.1 | 2024-12 | 字幕共享机制：通过 videoUrl 动态关联 |
| 2.2 | 2024-12 | 自动加载字幕：打开视频页面时自动恢复 |
