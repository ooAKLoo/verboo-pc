name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-mac:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # å¯¼å…¥ Apple è¯ä¹¦
      - name: Import Code Signing Certificate
        env:
          CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          # åˆ›å»ºä¸´æ—¶ keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          # åˆ›å»º keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # å¯¼å…¥è¯ä¹¦
          echo "$CERTIFICATE_BASE64" | base64 --decode > $RUNNER_TEMP/certificate.p12
          security import $RUNNER_TEMP/certificate.p12 -P "$CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"

          # è®¾ç½® keychain ä¸ºé»˜è®¤
          security list-keychain -d user -s "$KEYCHAIN_PATH"

          # å…è®¸ codesign è®¿é—®
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

      - name: Build macOS
        env:
          # å…¬è¯éœ€è¦çš„ç¯å¢ƒå˜é‡
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: npm run build && npx electron-builder --mac --publish never

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mac-build
          path: |
            release/*.dmg
            release/*.zip
            release/latest-mac.yml

  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Windows
        run: npm run build && npx electron-builder --win --publish never

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: |
            release/*.exe
            release/*.blockmap
            release/latest.yml

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Linux
        run: npm run build && npx electron-builder --linux --publish never

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: |
            release/*.AppImage
            release/*.deb
            release/*.rpm
            release/latest-linux.yml

  release:
    needs: [build-mac, build-windows, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/**/*.exe
            artifacts/**/*.blockmap
            artifacts/**/*.dmg
            artifacts/**/*.zip
            artifacts/**/*.AppImage
            artifacts/**/*.deb
            artifacts/**/*.rpm
            artifacts/**/latest*.yml
          generate_release_notes: true
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ä¸Šä¼ åˆ°é˜¿é‡Œäº‘ OSSï¼ˆå›½å†…åŠ é€Ÿä¸‹è½½ï¼‰
      - name: Setup aliyun ossutil
        uses: manyuanrong/setup-ossutil@v3.0
        with:
          endpoint: ${{ secrets.OSS_ENDPOINT }}
          access-key-id: ${{ secrets.OSS_ACCESS_KEY_ID }}
          access-key-secret: ${{ secrets.OSS_ACCESS_KEY_SECRET }}

      - name: Flatten artifacts
        run: |
          mkdir -p upload
          find artifacts/ -type f \( \
            -name "*.exe" -o -name "*.blockmap" -o -name "*.dmg" -o \
            -name "*.zip" -o -name "*.AppImage" -o -name "*.deb" -o \
            -name "*.rpm" -o -name "latest*.yml" \
          \) -exec cp {} upload/ \;
          echo "Files to upload:"
          ls -lh upload/

      - name: Generate download links file
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          VERSION_NUM=${VERSION#v}
          OSS_BASE="https://verboo.oss-cn-shanghai.aliyuncs.com/releases"
          GITHUB_BASE="https://github.com/ooAKLoo/verboo-pc/releases/download/${VERSION}"
          GITHUB_RELEASE="https://github.com/ooAKLoo/verboo-pc/releases/tag/${VERSION}"

          cat > upload/download.md << EOF
          # Verboo ${VERSION} ä¸‹è½½é“¾æ¥

          ---

          ## ğŸ‡¨ğŸ‡³ ä¸­å›½ç”¨æˆ·ï¼ˆå›½å†…é«˜é€Ÿä¸‹è½½ï¼‰

          **Windows:** ${OSS_BASE}/latest/Verboo.Setup.${VERSION_NUM}.exe
          **macOS (Apple Silicon):** ${OSS_BASE}/latest/Verboo-${VERSION_NUM}-arm64.dmg
          **Linux (AppImage):** ${OSS_BASE}/latest/Verboo-${VERSION_NUM}.AppImage
          **Linux (deb):** ${OSS_BASE}/latest/verboo_${VERSION_NUM}_amd64.deb

          ---

          ## ğŸŒ International Users (GitHub Download)

          **Windows:** ${GITHUB_BASE}/Verboo.Setup.${VERSION_NUM}.exe
          **macOS (Apple Silicon):** ${GITHUB_BASE}/Verboo-${VERSION_NUM}-arm64.dmg
          **Linux (AppImage):** ${GITHUB_BASE}/Verboo-${VERSION_NUM}.AppImage
          **Linux (deb):** ${GITHUB_BASE}/verboo_${VERSION_NUM}_amd64.deb

          ---

          **GitHub Release:** ${GITHUB_RELEASE}
          **ç‰ˆæœ¬ / Version:** ${VERSION}
          EOF

          # å»é™¤ heredoc ç¼©è¿›
          sed -i 's/^          //' upload/download.md

          echo "Generated download.md:"
          cat upload/download.md

      - name: Upload to Aliyun OSS
        run: |
          VERSION=${GITHUB_REF#refs/tags/}

          # ä¸Šä¼ åˆ° /releases/<version>/ ç›®å½•
          ossutil cp -rf upload/ oss://${{ secrets.OSS_BUCKET }}/releases/${VERSION}/

          # åŒæ—¶å¤åˆ¶åˆ° /releases/latest/ ä¾›è‡ªåŠ¨æ›´æ–°ä½¿ç”¨
          ossutil cp -rf upload/ oss://${{ secrets.OSS_BUCKET }}/releases/latest/
